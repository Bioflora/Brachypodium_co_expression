---
title: "WGCNA input preparation"
author: "Ruben Sancho, Bruno Contreras Moreira"
output:
  html_document: default
  pdf_document: default
---

```{r knitr setup, include=FALSE,  eval=TRUE, echo=FALSE, warning=FALSE}
library(knitr)
knitr::opts_chunk$set(eval=TRUE, cache=FALSE, message=FALSE, warning=FALSE, 
                      comment = "")
```

## Dependencies

These are installed as suggested by the 
[authors](https://labs.genetics.ucla.edu/horvath/CoexpressionNetwork/Rpackages/WGCNA/InstallationInstructions.html):


```{r data}

# Display the current working directory
getwd();

# If necessary, change the path below to the directory where the data files are stored.

# "." means current directory. On Windows use a forward slash / instead of the usual \.
workingDir = ".";
setwd(workingDir);

# Load the WGCNA package
library(WGCNA);
options(stringsAsFactors = FALSE);
allowWGCNAThreads();

# Data filtered by sleuth (see previous step).

# Tables build by _make_tsv_1gene_per_row.pl

# Dry (D)
dis_D_data = read.csv("kallisto_table_batch_date_review_D.csv")
dim(dis_D_data)
names(dis_D_data)

# WATER (W)
dis_W_data = read.csv("kallisto_table_batch_date_review_W.csv")
dim(dis_W_data)
names(dis_W_data)

# remove genes with too many missing samples in D
datExprD = as.data.frame(t(dis_D_data[, -c(1)]));
names(datExprD) = dis_D_data$target_id;
rownames(datExprD) = names(dis_D_data)[-c(1)];

gsgD = goodSamplesGenes(datExprD, verbose = 3);
if (!gsgD$allOK)
{
  # Optionally, print the gene and sample names that were removed:
  if (sum(!gsgD$goodGenes)>0) 
     printFlush(paste("Removing genes:", paste(names(datExprD)[!gsgD$goodGenes], collapse = ", ")));
  if (sum(!gsgD$goodSamples)>0) 
     printFlush(paste("Removing samples:", paste(rownames(datExprD)[!gsgD$goodSamples], collapse = ", ")));
  datExprD = datExprD[gsgD$goodSamples, gsgD$goodGenes]
  dim(datExprD)
}



# remove genes with too many missing samples in W
datExprW = as.data.frame(t(dis_W_data[, -c(1)]));
names(datExprW) = dis_W_data$target_id;
rownames(datExprW) = names(dis_W_data)[-c(1)];

gsgW = goodSamplesGenes(datExprW, verbose = 3);
if (!gsgW$allOK)
{
  # Optionally, print the gene and sample names that were removed:
  if (sum(!gsgW$goodGenes)>0) 
     printFlush(paste("Removing genes:", paste(names(datExprW)[!gsgW$goodGenes], collapse = ", ")));
  if (sum(!gsgW$goodSamples)>0) 
     printFlush(paste("Removing samples:", paste(rownames(datExprW)[!gsgW$goodSamples], collapse = ", ")));
  datExprW = datExprW[gsgW$goodSamples, gsgW$goodGenes]
  dim(datExprW)
}

```

```{r tree_samples}

## cluster and plot the samples (genes that will come later) to see if there are any obvious outliers --> D
sampleTreeD = hclust(dist(datExprD), method = "average")
sizeGrWindow(12,9)
png("dendrogram_D.png", width = 1600, height = 1200, units = "px", pointsize = 32, bg = "white");
par(cex = 0.6);
par(mar = c(0,4,2,0))
plot(sampleTreeD, main = "D Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, 
     cex.axis = 1.5, cex.main = 2)
outliersD=300000
abline(h=outliersD, col = "red"); # to mark/cut  outliers
dev.off()


## cluster and plot the samples (genes that will come later) to see if there are any obvious outliers --> W
sampleTreeW = hclust(dist(datExprW), method = "average")
sizeGrWindow(12,9)
png("dendrogram_W.png", width = 1600, height = 1200, units = "px", pointsize = 32, bg = "white");
par(cex = 0.6);
par(mar = c(0,4,2,0))
plot(sampleTreeW, main = "W Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, 
     cex.axis = 1.5, cex.main = 2)
outliersW=300000
abline(h=outliersW, col = "red"); # to mark/cut  outliers
dev.off()


## keep only desired samples D
clustD = cutreeStatic(sampleTreeD, cutHeight=outliersD, minSize = 20)
table(clustD)
keepSamplesD = (clustD==1)
datExprD = datExprD[keepSamplesD, ]
nGenesD = ncol(datExprD)
nSamplesD = nrow(datExprD)

## keep only desired samples W
clustW = cutreeStatic(sampleTreeW, cutHeight=outliersW, minSize = 20)
table(clustW)
keepSamplesW = (clustW==1)
datExprW = datExprW[keepSamplesW, ]
nGenesW = ncol(datExprW)
nSamplesW = nrow(datExprW)


## keep
save(datExprD, datExprW, file = "datExpr.RData")
```

![**Legend.** Clustering of D samples.](dendrogram_D.png)
![**Legend.** Clustering of W samples.](dendrogram_W.png)
